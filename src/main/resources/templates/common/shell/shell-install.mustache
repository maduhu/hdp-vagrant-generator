#!/bin/sh

# generated by https://github.com/timveil/hdp-vagrant-generator on {{generatedDate}}

wget -nv {{arguments.ambariRepoFileUrl}} -O /etc/yum.repos.d/ambari.repo

{{#arguments.updateLibraries}}
yum update -y -q
{{/arguments.updateLibraries}}

yum clean all
yum history new

{{#arguments.kerberosEnabled}}
yum install krb5-libs krb5-server krb5-workstation -y
{{/arguments.kerberosEnabled}}

yum install ambari-server ambari-agent -y

{{#arguments.kerberosEnabled}}
sed -i "s/kerberos.example.com/{{arguments.fqdn}}/gI" /etc/krb5.conf
sed -i "s/EXAMPLE.COM/{{arguments.kerberosRealm}}/gI" /etc/krb5.conf
sed -i "s/#//g" /etc/krb5.conf
sed -i "s/EXAMPLE.COM/{{arguments.kerberosRealm}}/gI" /var/kerberos/krb5kdc/kadm5.acl

kdb5_util create -s -P Bbh2z8HrVx
kadmin.local -q 'addprinc -pw admin admin/admin' -w Bbh2z8HrVx
systemctl start krb5kdc
systemctl enable krb5kdc
systemctl start kadmin
systemctl enable kadmin
{{/arguments.kerberosEnabled}}

sed -i "s/^hostname=localhost/hostname={{arguments.fqdn}}/g" /etc/ambari-agent/conf/ambari-agent.ini

ambari-server setup -s

ambari-server start

ambari-agent start

sleep 30

curl -s --show-error -H "{{requestedBy}}" -X POST -d '{{blueprintJson}}' -u admin:admin {{arguments.ambariApiBlueprintsUrl}}

{{#hdpRepoJson}}
curl --silent --show-error -H "{{requestedBy}}" -X PUT -d '{{hdpRepoJson}}' -u admin:admin {{arguments.ambariApiRepositoriesHdpUrl}}
{{/hdpRepoJson}}

{{#hdpUtilsRepoJson}}
curl --silent --show-error -H "{{requestedBy}}" -X PUT -d '{{hdpUtilsRepoJson}}' -u admin:admin {{arguments.ambariApiRepositoriesHdpUtilsUrl}}
{{/hdpUtilsRepoJson}}

curl -s --show-error -H "{{requestedBy}}" -X POST -d '{{createClusterJson}}' -u admin:admin {{arguments.ambariApiClustersUrl}}

PROGRESS=0
until [ $PROGRESS -eq 100 ]; do
    PROGRESS=`curl --silent --show-error -H "{{requestedBy}}" -X GET -u admin:admin {{arguments.ambariApiClustersRequestsUrl}} 2>&1 | grep -oP '\"progress_percent\"\s+\:\s+\K[0-9]+'`
    TIMESTAMP=$(date "+%m/%d/%y %H:%M:%S")
    echo -ne "$TIMESTAMP - $PROGRESS percent complete!"\\r
    sleep 60
done

useradd -G hdfs admin
usermod -a -G users admin
usermod -a -G hadoop admin
usermod -a -G hive admin

usermod -a -G users vagrant
usermod -a -G hdfs vagrant
usermod -a -G hadoop vagrant
usermod -a -G hive vagrant