# -*- mode: ruby -*-
# vi: set ft=ruby :

# Vagrantfile generated by https://github.com/timveil/hdp-vagrant-generator on {{generatedDate}}

require 'ffi'

Vagrant.configure("2") do |config|
    config.vm.box = "timveil/centos7-hdp-base"
    config.vm.box_check_update = true

    # configure VM
    config.vm.hostname = '{{arguments.fqdn}}'
    config.vm.network "private_network", ip: '{{arguments.ip}}'
    config.vm.provider "virtualbox" do |v|
        v.memory = {{arguments.memoryInMegabytes}}
        v.cpus = {{arguments.cores}}
        v.name = '{{arguments.fqdn}}'
    end

    if FFI::Platform::IS_MAC
        # configure host updater plugin - https://github.com/cogitatio/vagrant-hostsupdater
        config.hostsupdater.aliases = ["{{arguments.hostname}}"]

        # configure VirtualBox Guest Additions plugin - https://github.com/dotless-de/vagrant-vbguest
        config.vbguest.auto_update = true
        config.vbguest.no_remote = true
        config.vbguest.no_install = false
    end

    # provision VM
    config.vm.provision "Update Hosts File", type: "shell", inline: $updateHostsFile
    config.vm.provision "Clean Logs", type: "shell", inline: $cleanLogs, run: "always"
    config.vm.provision "Install", type: "shell", inline: $install
    config.vm.provision "Check Install Status", type: "shell", path: "vagrant-checkstatus.sh"
    config.vm.provision "Post Install", type: "shell", inline: $postInstall
    config.vm.provision "Install Complete", type: "shell", inline: $installComplete, run: "always"
end

$updateHostsFile = <<SCRIPT
cat > /etc/hosts <<EOF
127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6

{{arguments.ip}}   {{arguments.fqdn}} {{arguments.hostname}}
EOF
SCRIPT

$cleanLogs = <<SCRIPT
{{cleanLogsShellScript}}
SCRIPT

$install = <<SCRIPT
{{installShellScript}}
SCRIPT

$postInstall = <<SCRIPT
{{usersShellScript}}
SCRIPT

$installComplete = <<SCRIPT
echo "Ambari URL is http://{{arguments.fqdn}}:8080 or http://{{arguments.hostname}}:8080 or http://{{arguments.ip}}:8080"
SCRIPT