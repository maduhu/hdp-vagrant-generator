# -*- mode: ruby -*-
# vi: set ft=ruby :

# Vagrantfile generated by https://github.com/timveil/hdp-vagrant-generator on 6/20/16 10:24 PM



require 'ffi'

Vagrant.configure("2") do |config|
    config.vm.box = "timveil/centos7-hdp-base"
    config.vm.box_check_update = true

    # configure VM
    config.vm.hostname = 'kerberos.hdp.local'
    config.vm.network "private_network", ip: '192.168.7.101'
    config.vm.provider "virtualbox" do |v|
        v.memory = 4096
        v.cpus = 2
        v.name = 'kerberos.hdp.local'
    end

    # configure host updater plugin - https://github.com/cogitatio/vagrant-hostsupdater
    config.hostsupdater.aliases = ["kerberos"]

    # configure VirtualBox Guest Additions plugin - https://github.com/dotless-de/vagrant-vbguest
    config.vbguest.auto_update = true
    config.vbguest.no_remote = true
    config.vbguest.no_install = false

    # provision VM
    config.vm.provision "Update Hosts File", type: "shell", inline: $updateHostsFile
    config.vm.provision "Pre Install", type: "shell", inline: $preInstall, run: "always"
    config.vm.provision "Install", type: "shell", inline: $install
    config.vm.provision "Check Install Status", type: "shell", path: "vagrant-checkstatus.sh"
    config.vm.provision "Post Install", type: "shell", inline: $postInstall
    config.vm.provision "Install Complete", type: "shell", inline: $installComplete, run: "always"
end

$updateHostsFile = <<SCRIPT

cat > /etc/hosts <<EOF
127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6

192.168.7.201   repo.hdp.local

192.168.7.101   kerberos.hdp.local kerberos
EOF

SCRIPT

$preInstall = <<SCRIPT

echo " "
echo "---------------------------------------------------------------------------------------------------------------"
echo "----- Cleaning Logs"
echo "---------------------------------------------------------------------------------------------------------------"
echo " "

rm -rf /var/log/ambari-metrics-collector/*
rm -rf /var/log/ambari-metrics-monitor/*
rm -rf /var/log/falcon/*
rm -rf /var/log/flume/*
rm -rf /var/log/hadoop/hdfs/*
rm -rf /var/log/hadoop/mapreduce/*
rm -rf /var/log/hadoop/yarn/*
rm -rf /var/log/hadoop-mapreduce/mapred/*
rm -rf /var/log/hadoop-yarn/yarn/*
rm -rf /var/log/hadoop-yarn/nodemanager/*
rm -rf /var/log/hadoop-httpfs/*
rm -rf /var/log/hbase/*
rm -rf /var/log/hive/*
rm -rf /var/log/kafka/*
rm -rf /var/log/knox/*
rm -rf /var/log/oozie/*
rm -rf /var/log/ranger/admin/*
rm -rf /var/log/ranger/usersync/*
rm -rf /var/log/sqoop/*
rm -rf /var/log/storm/*
rm -rf /var/log/webhcat/*
rm -rf /var/log/zookeeper/*
rm -rf /tmp/hive/*
rm -rf /tmp/hcat/*
rm -rf /tmp/ambari-qa/*
rm -rf /tmp/root/*

SCRIPT

$install = <<SCRIPT

echo " "
echo "---------------------------------------------------------------------------------------------------------------"
echo "----- Cleaning YUM"
echo "---------------------------------------------------------------------------------------------------------------"
echo " "

yum clean all

echo " "
echo "---------------------------------------------------------------------------------------------------------------"
echo "----- Deleting YUM History"
echo "---------------------------------------------------------------------------------------------------------------"
echo " "

yum history new

echo " "
echo "---------------------------------------------------------------------------------------------------------------"
echo "----- Installing packages required for Kerberos"
echo "---------------------------------------------------------------------------------------------------------------"
echo " "

yum install krb5-libs krb5-server krb5-workstation -y

echo " "
echo "---------------------------------------------------------------------------------------------------------------"
echo "----- Updating Kerberos /etc/krb5.conf"
echo "---------------------------------------------------------------------------------------------------------------"
echo " "

sed -i "s/kerberos.example.com/kerberos.hdp.local/gI" /etc/krb5.conf
sed -i "s/EXAMPLE.COM/hdp.local/gI" /etc/krb5.conf
sed -i "s/#//g" /etc/krb5.conf
sed -i "s/EXAMPLE.COM/hdp.local/gI" /var/kerberos/krb5kdc/kadm5.acl

echo " "
echo "---------------------------------------------------------------------------------------------------------------"
echo "----- Starting Kerberos KDC"
echo "---------------------------------------------------------------------------------------------------------------"
echo " "

kdb5_util create -s -P Bbh2z8HrVx
kadmin.local -q 'addprinc -pw admin admin/admin' -w Bbh2z8HrVx
systemctl start krb5kdc
systemctl enable krb5kdc
systemctl start kadmin
systemctl enable kadmin


echo " "
echo "---------------------------------------------------------------------------------------------------------------"
echo "----- Getting Ambari YUM Repo from http://public-repo-1.hortonworks.com/ambari/centos7/2.x/updates/2.2.2.0/ambari.repo"
echo "---------------------------------------------------------------------------------------------------------------"
echo " "

wget -nv http://public-repo-1.hortonworks.com/ambari/centos7/2.x/updates/2.2.2.0/ambari.repo -O /etc/yum.repos.d/ambari.repo

echo " "
echo "---------------------------------------------------------------------------------------------------------------"
echo "----- Installing Ambari Server and Agent"
echo "---------------------------------------------------------------------------------------------------------------"
echo " "

yum install ambari-server ambari-agent -y

echo " "
echo "---------------------------------------------------------------------------------------------------------------"
echo "----- Updating Ambari Agent Hostname"
echo "---------------------------------------------------------------------------------------------------------------"
echo " "

sed -i "s/^hostname=localhost/hostname=kerberos.hdp.local/g" /etc/ambari-agent/conf/ambari-agent.ini

echo " "
echo "---------------------------------------------------------------------------------------------------------------"
echo "----- Running Ambari Server setup"
echo "---------------------------------------------------------------------------------------------------------------"
echo " "

ambari-server setup -s


echo " "
echo "---------------------------------------------------------------------------------------------------------------"
echo "----- Starting Ambari Server"
echo "---------------------------------------------------------------------------------------------------------------"
echo " "

ambari-server start

echo " "
echo "---------------------------------------------------------------------------------------------------------------"
echo "----- Starting Ambari Agent"
echo "---------------------------------------------------------------------------------------------------------------"
echo " "

ambari-agent start

echo " "
echo "---------------------------------------------------------------------------------------------------------------"
echo "----- Sleep..."
echo "---------------------------------------------------------------------------------------------------------------"
echo " "

sleep 30

echo " "
echo "---------------------------------------------------------------------------------------------------------------"
echo "----- Executing POST to Create Blueprint"
echo "---------------------------------------------------------------------------------------------------------------"
echo " "

curl -s --show-error -H "X-Requested-By: ambari" -X POST -d '{"configurations": [{"hdfs-site": {"properties": {"dfs.replication": "1"}}},{"core-site": {"properties": {"hadoop.proxyuser.root.groups": "*","hadoop.proxyuser.root.hosts": "*","hadoop.proxyuser.hcat.groups": "*","hadoop.proxyuser.hcat.hosts": "*"}}},{"webhcat-site": {"properties": {"webhcat.proxyuser.root.groups": "*","webhcat.proxyuser.root.hosts": "*"}}},{"mapred-site": {"properties": {"mapreduce.map.java.opts": "-Xmx409m","mapreduce.map.memory.mb": "512","mapreduce.reduce.java.opts": "-Xmx819m","mapreduce.reduce.memory.mb": "1024","yarn.app.mapreduce.am.command-opts": "-Xmx819m -Dhdp.version=${hdp.version}","yarn.app.mapreduce.am.resource.mb": "1024"}}},{"yarn-site": {"properties": {"yarn.nodemanager.resource.memory-mb": "2048","yarn.scheduler.maximum-allocation-mb": "2048","yarn.scheduler.minimum-allocation-mb": "512"}}},{"kerberos-env": {"properties" : {"realm" : "hdp.local","kdc_type" : "mit-kdc","kdc_host" : "kerberos.hdp.local","ldap_url" : "","container_dn" : "","encryption_types" : "aes des3-cbc-sha1 rc4 des-cbc-md5","admin_server_host" : "kerberos.hdp.local"}}},{"krb5-conf": {"properties" : {"domains" : "kerberos.hdp.local","manage_krb5_conf" : "true"}}}],"host_groups": [{"name": "host_group_1","configurations": [],"cardinality": "1","components": [{"name": "AMBARI_SERVER"},{"name": "APP_TIMELINE_SERVER"},{"name": "DATANODE"},{"name": "HCAT"},{"name": "HDFS_CLIENT"},{"name": "HISTORYSERVER"},{"name": "HIVE_CLIENT"},{"name": "HIVE_METASTORE"},{"name": "HIVE_SERVER"},{"name": "KERBEROS_CLIENT"},{"name": "MAPREDUCE2_CLIENT"},{"name": "METRICS_COLLECTOR"},{"name": "METRICS_MONITOR"},{"name": "MYSQL_SERVER"},{"name": "NAMENODE"},{"name": "NODEMANAGER"},{"name": "PIG"},{"name": "RESOURCEMANAGER"},{"name": "SECONDARY_NAMENODE"},{"name": "TEZ_CLIENT"},{"name": "WEBHCAT_SERVER"},{"name": "YARN_CLIENT"},{"name": "ZOOKEEPER_CLIENT"},{"name": "ZOOKEEPER_SERVER"}]}],"Blueprints": {"blueprint_name": "kerberos","stack_name": "HDP","stack_version": "2.4", "security" : {"type" : "KERBEROS"}}}' -u admin:admin http://kerberos.hdp.local:8080/api/v1/blueprints/kerberos



echo " "
echo "---------------------------------------------------------------------------------------------------------------"
echo "----- Executing POST to Install Cluster"
echo "---------------------------------------------------------------------------------------------------------------"
echo " "

curl -s --show-error -H "X-Requested-By: ambari" -X POST -d '{"blueprint" : "kerberos","default_password" : "password","credentials" : [{"alias" : "kdc.admin.credential","principal" : "admin/admin","key" : "admin","type" : "TEMPORARY"}],"security" : {"type" : "KERBEROS"},"host_groups" :[{"name" : "host_group_1","hosts" : [{"fqdn" : "kerberos.hdp.local"}]}]}' -u admin:admin http://kerberos.hdp.local:8080/api/v1/clusters/kerberos

echo " "
echo "---------------------------------------------------------------------------------------------------------------"
echo "----- Cluster is being installed!  You can check progress here:  http://kerberos.hdp.local:8080 or http://kerberos:8080"
echo "---------------------------------------------------------------------------------------------------------------"
echo " "


SCRIPT

$postInstall = <<SCRIPT

echo " "
echo "---------------------------------------------------------------------------------------------------------------"
echo "----- Adding Admin User"
echo "---------------------------------------------------------------------------------------------------------------"
echo " "

useradd -G hdfs admin
usermod -a -G users admin
usermod -a -G hadoop admin
usermod -a -G hive admin

echo " "
echo "---------------------------------------------------------------------------------------------------------------"
echo "----- Updating Vagrant User"
echo "---------------------------------------------------------------------------------------------------------------"
echo " "

usermod -a -G users vagrant
usermod -a -G hdfs vagrant
usermod -a -G hadoop vagrant
usermod -a -G hive vagrant

SCRIPT

$installComplete = <<SCRIPT

echo " "
echo "---------------------------------------------------------------------------------------------------------------"
echo "----- Ambari URL is http://kerberos.hdp.local:8080 or http://kerberos:8080"
echo "---------------------------------------------------------------------------------------------------------------"
echo " "


SCRIPT