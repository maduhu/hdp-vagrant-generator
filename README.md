# HDP Vagrant Generator

## Overview

A `Vagrantfile` generator for Hortonworks Data Platform (HDP).  Built using Spring Boot, this application will generate a `Vagrantfile` file based on the supplied `application.properties`.  This makes it very easy to create purpose built, custom Virtual Box HDP instances that are properly configured for your use case and hardware.


## How to run

To run, simply download or build the latest `hdp-vagrant-generator-*.jar`.  If you would like to customize, place a copy of `application.properties` in the same directory as the `hdp-vagrant-generator-*.jar` and from a command line run `java -jar hdp-vagrant-generator-*.jar`.  A directory named `out` will be created with your new `Vagrantfile` inside.

To use the newly created `Vagrantfile` make sure you have Vagrant installed along with the following plugins: 

```sh
vagrant plugin install vagrant-hostsupdater
vagrant plugin install vagrant-vbguest
```

Assuming, Vagrant and the required plugins are installed you can use you new image by running `vagrant up`.  The `Vagrantfile` will provision an HDP cluster based on your specifications.  The process usually takes about 20 minutes based on hardware and network connectivity.

## How to customize

You can change the configuration of the Virtual Box image or the HDP cluster by creating a file called `application.properties` and placing it in the same directory as `hdp-vagrant-generator-*.jar`.  The following values are used by default if no custom `application.properties` is provided.

```dosini
## ####################################### Logging Configurations

logging.level.root=WARN
logging.level.veil=INFO

logging.file=hdp-vagrant-generator.log

# ####################################### Required Configurations

# fully qualified domain name (FQDN) of virtual box image
vm.fqdn=default.hdp.local

# dns hostname of virtual box image
vm.hostname=default

# name of HDP cluster
hdp.cluster.name=default


# ####################################### Virtual Box Configurations

# ip address of virtual box image
vm.ip=192.168.7.101

# ram allocated to virtual box image in MB
vm.ram=8192

# number of cores allocated to virtual box image
vm.cores=4

# number of disks allocated virtual box image
vm.disks=1

# do you want yum to run update command during vagrant provisioning
vm.update.yum=true


# ####################################### HDP Configurations

# amount of memory reserved for system in MB
hdp.memory.reserved.system=2048

# amount of memory reserved for HBase in MB
hdp.memory.reserved.hbase=0

# minimum container size in MB
hdp.min.container.size=512

# Ambari blueprint name
hdp.blueprint.name=custom-generated-blueprint

# HDP stack version
hdp.stack.version=2.5

# Kerberos enabled?
hdp.kerberos.enabled=false

# if Kerberos is enabled, the realm (ex. "example.com")
hdp.kerberos.realm=

# HDP optional components installed
hdp.components=hive,spark

# URL of Ambari yum repo file (ex. "http://public-repo-1.hortonworks.com/ambari/centos7/2.x/updates/2.4.0.1/ambari.repo")
hdp.repo.ambari.file=http://public-repo-1.hortonworks.com/ambari/centos7/2.x/updates/2.4.0.1/ambari.repo

hdp.ambari.api.blueprints.url=http://${vm.fqdn}:8080/api/v1/blueprints/${hdp.blueprint.name}
hdp.ambari.api.clusters.url=http://${vm.fqdn}:8080/api/v1/clusters/${hdp.cluster.name}
hdp.ambari.api.clusters.requests.url=${hdp.ambari.api.clusters.url}/requests/1

# Custom Base URL for HDP Repo (ex. "http://repo.hdp.local/hdp/centos7/HDP-2.5.0.0")
hdp.repo.base=

# Custom Base URL for HDP Utils Repo (ex. "http://repo.hdp.local/hdp/centos7/HDP-UTILS-1.1.0.21")
hdp.repo.utils.base=

# API URL to create custom HDP Repo (ex. "http://${vm.fqdn}:8080/api/v1/stacks/HDP/versions/2.5/operating_systems/redhat7/repositories/HDP-2.5")
hdp.ambari.api.repositories.hdp.url=

# API URL to create custom HDP Utils Repo (ex. "http://${vm.fqdn}:8080/api/v1/stacks/HDP/versions/2.5/operating_systems/redhat7/repositories/HDP-UTILS-1.1.0.21")
hdp.ambari.api.repositories.hdputils.url=
```

## Example of generated Vagrantfile 

The below `Vagrantfile` was generated using the default `application.properties`.  More examples can be found here: https://github.com/timveil/hdp-vagrant-generator/tree/master/examples.

```rb
# -*- mode: ruby -*-
# vi: set ft=ruby :

# Vagrantfile generated by https://github.com/timveil/hdp-vagrant-generator on 9/2/16 10:53 AM

require 'ffi'

Vagrant.configure("2") do |config|
    config.vm.box = "timveil/centos7-hdp-base"
    config.vm.box_check_update = true

    # configure VM
    config.vm.hostname = 'default.hdp.local'
    config.vm.network "private_network", ip: '192.168.7.101'
    config.vm.provider "virtualbox" do |v|
        v.memory = 8192
        v.cpus = 4
        v.name = 'default.hdp.local'
    end

    if FFI::Platform::IS_MAC
        # configure host updater plugin - https://github.com/cogitatio/vagrant-hostsupdater
        config.hostsupdater.aliases = ["default"]

        # configure VirtualBox Guest Additions plugin - https://github.com/dotless-de/vagrant-vbguest
        config.vbguest.auto_update = true
        config.vbguest.no_remote = true
        config.vbguest.no_install = false
    end

    # provision VM
    config.vm.provision "Update Hosts File", type: "shell", inline: $updateHostsFile
    config.vm.provision "Clean Logs", type: "shell", inline: $cleanLogs, run: "always"
    config.vm.provision "Install", type: "shell", inline: $install
    config.vm.provision "Check Install Status", type: "shell", path: "vagrant-checkstatus.sh"
    config.vm.provision "Post Install", type: "shell", inline: $postInstall
    config.vm.provision "Install Complete", type: "shell", inline: $installComplete, run: "always"
end

$updateHostsFile = <<SCRIPT

cat > /etc/hosts <<EOF
127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6

192.168.7.201   repo.hdp.local

192.168.7.101   default.hdp.local default
EOF

SCRIPT

$cleanLogs = <<SCRIPT

echo " "
echo "---------------------------------------------------------------------------------------------------------------"
echo "----- Cleaning Logs"
echo "---------------------------------------------------------------------------------------------------------------"
echo " "

rm -rf /var/log/ambari-metrics-collector/*
rm -rf /var/log/ambari-metrics-monitor/*
rm -rf /var/log/falcon/*
rm -rf /var/log/flume/*
rm -rf /var/log/hadoop/hdfs/*
rm -rf /var/log/hadoop/mapreduce/*
rm -rf /var/log/hadoop/yarn/*
rm -rf /var/log/hadoop-mapreduce/mapred/*
rm -rf /var/log/hadoop-yarn/yarn/*
rm -rf /var/log/hadoop-yarn/nodemanager/*
rm -rf /var/log/hadoop-httpfs/*
rm -rf /var/log/hbase/*
rm -rf /var/log/hive/*
rm -rf /var/log/kafka/*
rm -rf /var/log/knox/*
rm -rf /var/log/oozie/*
rm -rf /var/log/ranger/admin/*
rm -rf /var/log/ranger/usersync/*
rm -rf /var/log/sqoop/*
rm -rf /var/log/storm/*
rm -rf /var/log/webhcat/*
rm -rf /var/log/zookeeper/*
rm -rf /tmp/hive/*
rm -rf /tmp/hcat/*
rm -rf /tmp/ambari-qa/*
rm -rf /tmp/root/*

SCRIPT

$install = <<SCRIPT

echo " "
echo "---------------------------------------------------------------------------------------------------------------"
echo "----- Cleaning YUM"
echo "---------------------------------------------------------------------------------------------------------------"
echo " "

yum clean all

echo " "
echo "---------------------------------------------------------------------------------------------------------------"
echo "----- Deleting YUM History"
echo "---------------------------------------------------------------------------------------------------------------"
echo " "

yum history new

echo " "
echo "---------------------------------------------------------------------------------------------------------------"
echo "----- Updating YUM"
echo "---------------------------------------------------------------------------------------------------------------"
echo " "

yum update -y -q

echo " "
echo "---------------------------------------------------------------------------------------------------------------"
echo "----- Getting Ambari YUM Repo from http://public-repo-1.hortonworks.com/ambari/centos7/2.x/updates/2.4.0.1/ambari.repo"
echo "---------------------------------------------------------------------------------------------------------------"
echo " "

wget -nv http://public-repo-1.hortonworks.com/ambari/centos7/2.x/updates/2.4.0.1/ambari.repo -O /etc/yum.repos.d/ambari.repo

echo " "
echo "---------------------------------------------------------------------------------------------------------------"
echo "----- Installing Ambari Server and Agent"
echo "---------------------------------------------------------------------------------------------------------------"
echo " "

yum install ambari-server ambari-agent -y

echo " "
echo "---------------------------------------------------------------------------------------------------------------"
echo "----- Updating Ambari Agent Hostname"
echo "---------------------------------------------------------------------------------------------------------------"
echo " "

sed -i "s/^hostname=localhost/hostname=default.hdp.local/g" /etc/ambari-agent/conf/ambari-agent.ini

echo " "
echo "---------------------------------------------------------------------------------------------------------------"
echo "----- Running Ambari Server setup"
echo "---------------------------------------------------------------------------------------------------------------"
echo " "

ambari-server setup -s

echo " "
echo "---------------------------------------------------------------------------------------------------------------"
echo "----- Starting Ambari Server"
echo "---------------------------------------------------------------------------------------------------------------"
echo " "

ambari-server start

echo " "
echo "---------------------------------------------------------------------------------------------------------------"
echo "----- Starting Ambari Agent"
echo "---------------------------------------------------------------------------------------------------------------"
echo " "

ambari-agent start

echo " "
echo "---------------------------------------------------------------------------------------------------------------"
echo "----- Sleep..."
echo "---------------------------------------------------------------------------------------------------------------"
echo " "

sleep 30

echo " "
echo "---------------------------------------------------------------------------------------------------------------"
echo "----- Executing POST to Create Blueprint"
echo "---------------------------------------------------------------------------------------------------------------"
echo " "

curl -s --show-error -H "X-Requested-By: ambari" -X POST -d '{"configurations": [{"hdfs-site": {"properties": {"dfs.replication": "1"}}},{"core-site": {"properties": {"hadoop.proxyuser.root.groups": "*","hadoop.proxyuser.root.hosts": "*","hadoop.proxyuser.hcat.groups": "*","hadoop.proxyuser.hcat.hosts": "*"}}},{"webhcat-site": {"properties": {"webhcat.proxyuser.root.groups": "*","webhcat.proxyuser.root.hosts": "*"}}},{"mapred-site": {"properties": {"mapreduce.map.java.opts": "-Xmx614m","mapreduce.map.memory.mb": "768","mapreduce.reduce.java.opts": "-Xmx1228m","mapreduce.reduce.memory.mb": "1536","yarn.app.mapreduce.am.command-opts": "-Xmx1228m -Dhdp.version=${hdp.version}","yarn.app.mapreduce.am.resource.mb": "1536"}}},{"yarn-site": {"properties": {"yarn.nodemanager.resource.memory-mb": "6144","yarn.scheduler.maximum-allocation-mb": "6144","yarn.scheduler.minimum-allocation-mb": "768"}}}],"host_groups": [{"name": "host_group_1","configurations": [],"cardinality": "1","components": [{"name": "AMBARI_SERVER"},{"name": "APP_TIMELINE_SERVER"},{"name": "DATANODE"},{"name": "HCAT"},{"name": "HDFS_CLIENT"},{"name": "HISTORYSERVER"},{"name": "SPARK_JOBHISTORYSERVER"},{"name": "SPARK_CLIENT"},{"name": "HIVE_CLIENT"},{"name": "HIVE_METASTORE"},{"name": "HIVE_SERVER"},{"name": "MAPREDUCE2_CLIENT"},{"name": "METRICS_COLLECTOR"},{"name": "METRICS_MONITOR"},{"name": "MYSQL_SERVER"},{"name": "NAMENODE"},{"name": "NODEMANAGER"},{"name": "PIG"},{"name": "RESOURCEMANAGER"},{"name": "SECONDARY_NAMENODE"},{"name": "TEZ_CLIENT"},{"name": "WEBHCAT_SERVER"},{"name": "YARN_CLIENT"},{"name": "ZOOKEEPER_CLIENT"},{"name": "ZOOKEEPER_SERVER"}]}],"Blueprints": {"blueprint_name": "custom-generated-blueprint","stack_name": "HDP","stack_version": "2.5"}}' -u admin:admin http://default.hdp.local:8080/api/v1/blueprints/custom-generated-blueprint

echo " "
echo "---------------------------------------------------------------------------------------------------------------"
echo "----- Executing POST to Install Cluster"
echo "---------------------------------------------------------------------------------------------------------------"
echo " "

curl -s --show-error -H "X-Requested-By: ambari" -X POST -d '{"blueprint" : "custom-generated-blueprint","default_password" : "password","host_groups" :[{"name" : "host_group_1","hosts" : [{"fqdn" : "default.hdp.local"}]}]}' -u admin:admin http://default.hdp.local:8080/api/v1/clusters/default

echo " "
echo "---------------------------------------------------------------------------------------------------------------"
echo "----- Cluster is being installed!  You can check progress here:  http://default.hdp.local:8080 or http://default:8080"
echo "---------------------------------------------------------------------------------------------------------------"
echo " "

SCRIPT

$postInstall = <<SCRIPT

echo " "
echo "---------------------------------------------------------------------------------------------------------------"
echo "----- Adding Admin User"
echo "---------------------------------------------------------------------------------------------------------------"
echo " "

useradd -G hdfs admin
usermod -a -G users admin
usermod -a -G hadoop admin
usermod -a -G hive admin

echo " "
echo "---------------------------------------------------------------------------------------------------------------"
echo "----- Updating Vagrant User"
echo "---------------------------------------------------------------------------------------------------------------"
echo " "

usermod -a -G users vagrant
usermod -a -G hdfs vagrant
usermod -a -G hadoop vagrant
usermod -a -G hive vagrant

SCRIPT

$installComplete = <<SCRIPT

echo " "
echo "---------------------------------------------------------------------------------------------------------------"
echo "----- Ambari URL is http://default.hdp.local:8080 or http://default:8080"
echo "---------------------------------------------------------------------------------------------------------------"
echo " "

SCRIPT
```